pipeline {
    agent {
        node {
            label "test"
        }
    }
    environment {
        dotnet = "C:\\Program Files\\dotnet\\dotnet.exe"
        api_dockerhub_repo = "huynguyen260398/blazing-portfolio-api"
        wasm_dockerhub_repo = "huynguyen260398/blazing-portfolio-wasm"
        dockerhub_credentials = "DockerHub_Credentials"
        api_image = ""
        wasm_image = ""
    }
    stages {
        stage("Restore Packages") {
            steps {
                bat "dotnet restore"
            }
        }
        stage("Test Sources") {
            steps {
                echo "Test"
            }
        }
        stage("Build Sources") {
            steps {
                bat "dotnet build"
            }
        }
        stage("Build Images") {
            steps {
                script {
                    api_image = docker.build("${api_dockerhub_repo}:1.${BUILD_NUMBER}", "-f src/API/Dockerfile .")
                    wasm_image = docker.build("${wasm_dockerhub_repo}:1.${BUILD_NUMBER}", "-f src/WASM/Dockerfile .")
                }
            }
        }
        stage("Deploy Images") {
            steps {
                script {
                    docker.withRegistry("", dockerhub_credentials)
                    api_image.push()
                    wasm_image.push()
                }
            }
        }
        stage("Clean Workspace") {
            steps {
                cleanWs()
            }
        }
    }
}